#!/opt/python3/bin/python3
# -*- coding: utf-8 -*-

"""Invoke Polaris distributor - PDNS Remote Backend JSON-API client"""

import os
import inspect
import re

import polaris
import polaris.distributor
import polaris.util.logging

# determine the install prefix
path = os.path.abspath(
    os.path.split(inspect.getfile( inspect.currentframe() ))[0])
m = re.search(r'(.+)\/bin', path)
if m:
    prefix = m.group(1)
else:
    print('Cannot determine the installation directory prefix')
    exit(1)

# load shared configuration
polaris.config.load(
    base_config_path='{}/etc/polaris/base.yaml'.format(prefix),
    lb_config_path='{}/etc/polaris/lb.yaml'.format(prefix),
    topology_config_path='{}/etc/polaris/topology.yaml'.format(prefix))

# setup logging
if polaris.config.base['distributor']['log_level'] != 'none':
    polaris.util.logging.setup(
        level=polaris.config.base['distributor']['log_level'],
        handler=polaris.config.base['logging']['handler'],
        hostname=polaris.config.base['logging']['hostname'],
        port=polaris.config.base['logging']['port'])

# start distributor
polaris.distributor.main()

