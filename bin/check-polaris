#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""Polaris health check script, needs to be run as root to access 
PDNS control socket.
"""

import json
import time
import subprocess

import memcache

MEMCACHED_HOSTNAME = '127.0.0.1'
HEARTBEAT_KEY = 'polaris:health:heartbeat'
PDNS_CONTROL = '/usr/local/bin/pdns_control'

class Status():

    def __init__(self):
        pass

    def ok(self, msg):
        print('OK: {}'.format(msg))

    def major(self, msg):
        print('MAJOR: {}'.format(msg))
        exit(1)

    def critical(self, msg):
        print('CRITICAL: {}'.format(msg))
        exit(2)

STATUS = Status()

def check_health():
    mc = memcache.Client([MEMCACHED_HOSTNAME])

    hb = mc.get(HEARTBEAT_KEY)
    if hb is None:
        STATUS.critical('failed to retrieve heartbeat')

    obj = json.loads(hb)

    if time.time() - obj['timestamp'] > 21:
        STATUS.critical('aged timestamp: {}'.
                format(time.asctime(time.gmtime(obj['timestamp']))))

    if obj['child_procs_alive'] != obj['child_procs_total']:
        STATUS.critical('child_procs_alive: {}, child_procs_total: {}'
                .format(obj['child_procs_alive'], obj['child_procs_total']))

    if obj['probe_req_queue_len'] > 100:
        STATUS.critical(
            'probe_req_queue_len: {}'.format(obj['probe_req_queue_len']))

    if obj['probe_resp_queue_len'] > 100:
        STATUS.critical(
            'probe_resp_queue_len: {}'.format(obj['probe_resp_queue_len']))

def check_pdns():
    ret_code = subprocess.call([PDNS_CONTROL, 'status'], 
                               stderr=subprocess.DEVNULL,
                               stdout=subprocess.DEVNULL)
    if ret_code != 0:
        STATUS.critical('pdns is not running')

if __name__ == '__main__':
    check_health()
    check_pdns()
    STATUS.ok('all checks passed')

