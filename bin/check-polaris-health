#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""Polaris_health health check"""

import json
import time

import memcache

MEMCACHED_HOSTNAME = '127.0.0.1'
HEARTBEAT_KEY = 'polaris_health:heartbeat'

class Status():

    def __init__(self):
        pass

    def ok(self, msg):
        print('OK: {}'.format(msg))

    def major(self, msg):
        print('MAJOR: {}'.format(msg))
        exit(1)

    def critical(self, msg):
        print('CRITICAL: {}'.format(msg))
        exit(2)

STATUS = Status()

def check_health():
    mc = memcache.Client([MEMCACHED_HOSTNAME])

    hb = mc.get(HEARTBEAT_KEY)
    if hb is None:
        STATUS.critical('failed to retrieve heartbeat')

    obj = json.loads(hb)

    if time.time() - obj['timestamp'] > 5:
        STATUS.critical('aged timestamp: {}'.
                format(time.asctime(time.gmtime(obj['timestamp']))))

if __name__ == '__main__':
    check_health()
    STATUS.ok('all checks passed')

